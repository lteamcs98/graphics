doctype html
html
	head
		title Challenge #{challengeId}

		link(rel='stylesheet', href='http://fonts.googleapis.com/css?family=Montserrat')
		link(rel='stylesheet', href='http://fonts.googleapis.com/css?family=Lato')

		link(rel='stylesheet', href='../css/codemirror.css')
		link(rel='stylesheet', href='../css/light-table.css')
		link(rel='stylesheet', href='../css/lint.css')
		link(rel='stylesheet', href='../css/normalize.css')
		link(rel='stylesheet', href='../css/style.css')

		script(src='//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js')
		//script(src='http://interactiveclassroom.herokuapp.com/socket.io/socket.io.js')
		script(src="../socket.io/socket.io.js")


		script(src='../js/codemirror.js')
		script(src='../js/javascript-lint.js')
		script(src='../js/javascript.js')
		script(src='../js/jshint.js')
		script(src='../js/lint.js')

	body

		div(class='grid grid-pad')
			div(class='col-1')
				h2 Challenge #{challengeId}: #{title}
				p #{problem}

			div(class='col-2-3 row-1-2')
				textarea(id='editor')
				button(class='button' id='emailButton' type='button') Email
				button(class='button' id='submitButton' type='button') Submit
			div(class='col-1-3 row-1-2')
				select(id='codeUnitList')
					option
						selected
						value='All'
				div(id='results')
					h2 Results

			div(class='col-1' id='console')
				h2 Console

		script(src='../js/console_capture.js')
		script(src='../js/challenge.js')
		script(src='../js/cm-resize.js')
		script.

			var socket = io.connect('http://localhost');
			//var socket = io.connect('http://interactiveclassroom.herokuapp.com');

			var outputArray = !{ JSON.stringify(outputArray) };
			var inputArray = !{ JSON.stringify(inputArray) };

			var challengeId = Number(#{challengeId});

			var functionNames = !{ JSON.stringify(functionNames) };
			addFunctionOptions(functionNames);

			//console.log(!{JSON.stringify(oldSub)});

			//editor.setValue(!{JSON.stringify(oldSub)});

			$('#submitButton').click(function() {
				$('#results').html('<h2>Results</h2>');

				var testIndex = document.getElementById("codeUnitList").selectedIndex;
				var testAll = (testIndex === 0);
				var functions = new Array();
				if (testAll)
				{
					functions = functionNames;
				} else
				{
					functions.push(document.getElementById("codeUnitList").options[testIndex].value);
				}

				totalTests = 0;
				correctTests = 0;
				var failedTests = new Array();
				for(var i in functions)
				{
					result = evaluateFunction(functions[i]);
					if(typeof result == 'number')
					{
						continue;
					}
					totalTests += result[0];
					correctTests += result[1];
					failedTests.push({functionName: functions[i], failedTests: result[2]});
				}
				if(totalTests > 0)
				{
					var percent = (100.0 * correctTests / totalTests);
					$('#outputBox').append('<p class="challengeTitle">' + percent + "% Correct</p>");
				}
				else
				{
					$('#outputBox').append('<p class="challengeTitle">No results to display</p>');

				}

				console.log("Sending user code to database");

				
				
				// send data back to server
				socket.emit('results',
					{
						userId: !{personsID}, //new String("#{username}"),
						challengeId: !{challengeId},
						userCode: editor.getValue()
					}
				);
				
				

			});

			$('#emailButton').click(function() {
				//test.apply(null, strings)

				var personsCode = editor.getValue();
				personsCode = personsCode.replace(/\n/g, '%0D%0A');
				personsCode = personsCode.replace(/\t/g, '    ');
				var personsSubject = #{title}

				window.open(
					'mailto:first.middle.last.year@dartmouth.edu?'
					+ '&subject=Challenge ' + #{challengeId}
					+ '&body=' + personsCode
				);
			});
